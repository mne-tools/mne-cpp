name: WamTest

on:
  push:
    branches:
    # Change this to the branch name you make changes to the documentation on
    - alternate

jobs:
  WasmTest:
    runs-on: ubuntu-latest

    steps:
    - name: Clone repository
      uses: actions/checkout@v2
    - name: Setup Github credentials
      uses: fusion-engineering/setup-git-credentials@v2
      with:
        credentials: ${{secrets.GIT_CREDENTIALS_DOCU_TEST}}
    - name: Setup emscripten compiler 
      run: |
        cd ..
        # Get the emsdk repo
        git clone https://github.com/emscripten-core/emsdk.git
        # Enter that directory and pull
        cd emsdk
        git pull
        # Download and install the latest SDK tools.
        ./emsdk install 1.39.3     
    # - name: Install Qt
    #   run: |
    #     # Download the pre-built static version of Qt, which was created with the generateBinaries.yml workflow
    #     wget -O qt5_5142_static_binaries_wasm.tar.gz https://www.dropbox.com/s/k245dalpw02ok1q/qt5_5142_static_binaries_wasm.tar.tar.gz?dl=1
    #     mkdir ../Qt5_binaries
    #     tar xvzf qt5_5142_static_binaries_wasm.tar.gz -C ../ -P  
    # Uncomment this if you want to build Qt statically in this workflow         
    - name: Compile wasm Qt version
      run: |
        cd ..
        # Make the "latest" emscripten SDK "active" for the current user.
        ./emsdk/emsdk activate 1.39.3
        # Activate PATH and other environment variables in the current terminal
        source ./emsdk/emsdk_env.sh
        # Clone Qt5 repo
        git clone https://code.qt.io/qt/qt5.git -b 5.14.2
        cd qt5
        ./init-repository -f --module-subset=qtbase,qtcharts,qtsvg
        # Configure Qt5
        ./configure -xplatform wasm-emscripten -feature-thread -skip webengine -nomake tests -nomake examples -no-dbus -no-ssl -no-pch -opensource -confirm-license -prefix "$PWD/../Qt5_binaries"
        make module-qtbase module-qtsvg module-qtcharts -j4
        make install -j4
    - name: Configure and compile MNE-CPP
      run: |
        cd ..
        # Make the "latest" emscripten SDK "active" for the current user.
        ./emsdk/emsdk activate 1.39.3
        # Activate PATH and other environment variables in the current terminal
        source ./emsdk/emsdk_env.sh
        # Compile MNE-CPP        
        cd mne-cpp
        ../Qt5_binaries/bin/qmake -r MNECPP_CONFIG=wasm
        make -j4
    - name: Clone and update mne-cpp/wasm:gh-pages
      run: |
        # Delete folders which we do not want to ship
        rm -r bin/mne_analyze_extensions
        rm -r bin/mne-cpp-test-data
        rm -r bin/MNE-sample-data
        # Clone repo and update with new wasm versions
        git config --global user.email lorenzesch@hotmail.com
        git config --global user.name LorenzE
        git clone -b gh-pages --single-branch https://github.com/mne-cpp/wasm.git
        cd wasm
        # Remove all files first
        git rm * -r
        git commit --amend -a -m 'Update wasm builds' --allow-empty
        cd ..
        cp -RT bin wasm
        cd wasm
        git add .
        git commit --amend -a -m 'Update wasm builds'
        git push -f --all


    # - name: Clone doc/gh-pages into gh-pages branch
    #   run: |
    #     # Delete folders which we do not want to ship
    #     rm -r bin/mne_analyze_extensions
    #     rm -r bin/mne-cpp-test-data
    #     rm -r bin/MNE-sample-data
    #     # Copy the wasm files first
    #     cp -RT bin/ .
    #     cp -RT ../mne-cpp/bin ../bin
    #     # Setup git credentials
    #     git config --global user.email dev@dev.com
    #     git config --global user.name dev
    #     # Checkout the gh-pages branch
    #     git fetch origin gh-pages
    #     git checkout --track origin/gh-pages
    #     # Remove all files first
    #     git rm * -r
    #     git commit --amend -a -m 'Update wasm' --allow-empty
    #     # Add the changed doc files
    #     cp -RT ../bin ../mne-cpp
    #     git add --all
    #     git commit --amend -a -m 'Update wasm'
    #     git push -f --all
        
    # - name: Clone and update mne-cpp/wasm:gh-pages
    #   run: |
    #     # Delete folders which we do not want to ship
    #     rm -r bin/mne_analyze_extensions
    #     rm -r bin/mne-cpp-test-data
    #     rm -r bin/MNE-sample-data
    #     # Clone repo and update with new wasm versions
    #     git config --global user.email lorenzesch@hotmail.com
    #     git config --global user.name LorenzE
    #     git clone -b gh-pages --single-branch https://github.com/mne-cpp/wasm.git
    #     cd wasm
    #     # Remove all files first
    #     git rm * -r
    #     git commit --amend -a -m 'Update wasm builds' --allow-empty
    #     cd ..
    #     cp -RT bin wasm
    #     cd wasm
    #     git add .
    #     git commit --amend -a -m 'Update wasm builds'
    #     git push -f --all